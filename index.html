<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>2D</title>
  <meta name="description" content="2D Game">
  <meta name="author" content="Kevin Albertson">
  <style type="text/css">
  body{
    background: #555;
  }
  #container{
    margin: 50px auto;
    width: 800px;
  }
  </style>
  

  <!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>

<body>
	<div id="container">
    <div id="game"></div>
  </div>
  <script src="js/phaser.js"></script>
  <script src="js/enemy.js"></script>
  <script>

  	var game = new Phaser.Game(800, 600, Phaser.AUTO, "game", {preload: preload, create: create, update: update, render: render});
  	var pl = null;
    var pl_bullets = null;
    var e1 = null;
    var diamonds = null;
    var dMeter = 0;
  	var cursors = null;
    var locked = false;
    var lockTimer = 100;
    var endLevel = false;
    var endLevelTimer = 0;

    var portal = null;
    var portalOpening = null;
    var portalOpen = null;
    var portalAvailable = false;

    var level = 1;




  	function preload(){
  		game.load.image("player", "img/player-glow.png");
      game.load.image("bullet", "img/bullet-glow.png");
      game.load.image("bg", "img/bg.png");
      game.load.image("enemy1", "img/enemy.png");
      game.load.image("portal-closed", "img/portal.png");
      game.load.image("portal-opening", "img/opening.png");
      game.load.image("portal-open", "img/portal-open.png");
      game.load.image("diamond", "img/diamond.png");
  	}

  	function create(){
      game.add.tileSprite(0,0,1200,1000,"bg");
      game.world.setBounds(0,0,1200,1000);
  		game.physics.startSystem(Phaser.Physics.ARCADE);

      //Portal set up
      portal = game.add.sprite(0, 0, "portal-closed");
      portal.visible = false;
      game.physics.enable(portal, Phaser.Physics.ARCADE);
      portal.body.immovable = true;
      portal.anchor.setTo(.5, .5);
      portal.body.setSize(46, 46);

      portalOpening = game.add.sprite(portal.body.x, portal.body.y, "portal-opening");
      portalOpening.anchor.setTo(.5, .5);
      portalOpening.scale.setTo(0,0);

      portalOpen = game.add.sprite(portal.body.x, portal.body.y, "portal-open");
      portalOpen.anchor.setTo(.5, .5);
      portalOpen.visible = false;


      //Player set up
  		pl = game.add.sprite(game.width/2 - 8, game.height/2 - 8,"player");
  		game.physics.enable(pl, Phaser.Physics.ARCADE);
  		pl.body.collideWorldBounds = true;
      pl.body.setSize(16, 16, 0, 0);
      pl.anchor.set(.5);
      pl.cameraOffset.x = 100;
      pl.cameraOffset.y = 100;
      game.camera.follow(pl);

      //Player bullets set up
      pl_bullets = game.add.group();
      pl_bullets.enableBody = true;
      pl_bullets.physicsBodyType = Phaser.Physics.ARCADE;

      //Enemy set up
      e1 = game.add.group();
      e1.enableBody = true;
      e1.physicsBodyType = Phaser.Physics.ARCADE;


      //Diamond set up
      diamonds = game.add.group();
      diamonds.enableBody = true;
      diamonds.physicsBodyType = Phaser.Physics.ARCADE;

  		cursors = {
        up: game.input.keyboard.addKey(Phaser.Keyboard.W),
        left: game.input.keyboard.addKey(Phaser.Keyboard.A),
        right: game.input.keyboard.addKey(Phaser.Keyboard.D),
        down: game.input.keyboard.addKey(Phaser.Keyboard.S)
      };
  	}

    function createExplosion(){

    }

    function showPortal(x,y){
      x = Math.floor(x / 16) * 16 + 13;
      y = Math.floor(y / 16) * 16 + 13;
      portal.x = x;
      portal.y = y;
      portal.visible = true;
      portalOpening.x = x;
      portalOpening.y = y;
      portalOpen.x = portal.x;
      portalOpen.y = portal.y;
      portalAvailable = true;
    }



    function onPortalHit(portal, bullet){
      bullet.kill();
      
      if(portalOpening.scale.x >= 1){
        //end level
        portalOpen.visible = true;
        endLevel = true;
      }
      else{
        portalOpening.scale.x += .05;
        portalOpening.scale.y += .05;
      }
    }

    //For some unknown reason, order is flipped, perhaps because player is sprite and enemy is group??
    function onEnemyPlayerCollision(player, enemy){
      enemy.kill();
      //TODO: reduce player health
    }

    function onDiamondCollision(player, diamond){
      diamond.kill();
      dMeter += 1; //increase portal meter
      if(dMeter > 0){
        //show portal
        var xVar = 100, yVar = 100;
        if(pl.x + 100 > game.world.width) xVar = -100;
        if(pl.y + 100 > game.world.height) yVar = -100;
        showPortal(pl.x + xVar, pl.y + yVar);
      }
      
    }

  	function update(){
      //portalOpening.x = pl.body.x;
      if(endLevel){
        var finalVelocityX = (portal.body.x - pl.body.x)/10;
        pl.body.velocity.x += finalVelocityX/10;
        if(pl.body.velocity.x > finalVelocityX){
          pl.body.velocity.x = finalVelocityX;
        }
        var finalVelocityY = (portal.body.y - pl.body.y)/10;
        pl.body.velocity.y += finalVelocityY/10;
        if(pl.body.velocity.y > finalVelocityY){
          pl.body.velocity.y = finalVelocityY;
        }
        if(pl.scale.x > 0){
          pl.scale.x -= .01;
          pl.scale.y -= .01;
        }
        endLevelTimer += game.time.elapsed;
        if(endLevelTimer >= 2000){
          console.log("WIN");
          endLevel = false;
        }

        return;
      }
      var pl_angle = Math.PI + game.physics.arcade.angleToPointer(pl);
      pl.rotation = pl_angle;
      var s = 200;
      var dir = 0;
  		if(cursors.left.isDown){
  			dir = -1;
  		}
  		else if(cursors.right.isDown){
  			dir = 1;
  		}
      if(dir != 0){
        pl.body.velocity.x += (dir * s) / 10;
        if(Math.abs(pl.body.velocity.x) > s){
          pl.body.velocity.x = dir * s;
        }
      }
      else{
        pl.body.velocity.x /= 1.1;
      }

      dir = 0;
      if(cursors.up.isDown){
        dir = -1;
      }
      else if(cursors.down.isDown){
        dir = 1;
      }
      if(dir != 0){
        pl.body.velocity.y += (dir * s) / 10;
        if(Math.abs(pl.body.velocity.y) > s){
          pl.body.velocity.y = dir * s;
        }
      }
      else{
        pl.body.velocity.y /= 1.1;
      }

      if(game.input.mouse.button == Phaser.Mouse.LEFT_BUTTON && !locked){
        locked = true;
        lockTimer = 200;
        //fire on interval
        var b = pl_bullets.getFirstDead();
        if(b != null){
          b.reset(pl.body.x + pl.body.width/2, pl.body.y + pl.body.height/2);
        }
        else{
          b = pl_bullets.create(pl.body.x + pl.body.width/2, pl.body.y + pl.body.height/2, "bullet");
        }
        var bs = 350;
        b.body.setSize(5,5, 0,0);
        b.anchor.setTo(.5, .5);
        b.checkWorldBounds = true;
        b.outOfBoundsKill = true;
        b.rotation = pl_angle;
        
        b.body.velocity.x = -1 * bs * Math.cos(pl_angle);
        b.body.velocity.y = -1 * bs * Math.sin(pl_angle);
      }
      else{
        lockTimer -= game.time.elapsed;
        if(lockTimer <= 0){
          locked = false;
        }
      }
      
      if(portalAvailable){
        game.physics.arcade.collide(pl, portal);
      }
      game.physics.arcade.overlap(e1, pl_bullets, onEnemyHit);
      game.physics.arcade.overlap(e1, pl, onEnemyPlayerCollision);
      if(portalAvailable){
        game.physics.arcade.overlap(portal, pl_bullets, onPortalHit);
      }
      game.physics.arcade.overlap(diamonds, pl, onDiamondCollision);
      enemyGen();
      killOutOfBoundEnemies();
  	}
  	function render(){
      //game.debug.body(pl);
      //game.debug.body(e1.getFirstAlive());
      if(pl_bullets.getFirstAlive()){
        //game.debug.body(pl_bullets.getFirstAlive());
      }
    }


  </script>
</body>
</html>